name: CI/CD Deploy to K3s
on:
  push:
    branches: [ main ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
       # 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
      - name: Checkout code
        uses: actions/checkout@v4
      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      # 3Ô∏è‚É£ –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞   
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/grafan:latest .
      # 4Ô∏è‚É£ –õ–æ–≥–∏–Ω –≤ Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      # 5Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞
      - name: Push image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/grafan:latest

        # 6Ô∏è‚É£ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –Ω–∞ VPS
      - name: Copy manifests to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "./k8s"
          target: "~/grafan/k8s"

         # 7Ô∏è‚É£ –î–µ–ø–ª–æ–π –≤ K3s
      - name: Deploy to K3s
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            export KUBECONFIG=/etc/rancher/k3s/kubeconfig.yaml
            echo "üì¶ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–∞—Ç–∞–ª–æ–≥ –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤"
            cd ~/grafan/k8s

            echo "üßπ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É:"
            ls -l

            echo "üöÄ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã"
            kubectl apply -f deployment.yaml
            kubectl apply -f service.yaml
            kubectl apply -f prometheus.yaml

            echo "‚è≥ –û–∂–∏–¥–∞–µ–º –ø–æ–¥—ã..."
            kubectl rollout status deployment grafan-deployment -n default --timeout=120s

            echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
